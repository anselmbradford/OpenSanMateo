<?php
/**
 * @file
 * Code for the OpenSanMateo Search feature.
 */

include_once 'opensanmateo_layout.features.inc';
/**
 * @file
 * Code for the OpenSanMateo Example feature.
 */


/**
 * Implments hook_theme()
 */
function opensanmateo_layout_theme() {
  return array(
    'opensanmateo_layout_site_brand' => array(
      'template' => 'opensanmateo_layout_site_brand',
      'variables' => array(
        'logo' => NULL,
        'slogan' => NULL,
        'name' => NULL,
      ),
    )
  );
}

/**
 * Implements hook_block_info().
 */
function opensanmateo_layout_block_info() {
  $blocks['opensanmateo_layout_banner'] = array(
    'info' => t('Shared Banner'),
    'cache' => DRUPAL_CACHE_GLOBAL
  );
  $blocks['opensanmateo_layout_site_brand'] = array(
    'info' => t('Site Brand'),
    'cache' => DRUPAL_CACHE_GLOBAL
  );
  
  return $blocks;
}

/**
 * Implements hook_block_configure().
 */
function opensanmateo_layout_block_configure($delta = '') {
  $form = array();
  if ($delta == 'opensanmateo_layout_banner') {
    $form['banner_content'] = array(
      '#type' => 'text_format',
      '#title' => t('Banner block content'),
      '#description' => t('The contents of the block we\'re going to share across our sites.'),
      '#default_value' => variable_get('opensanmateo_layout_banner_content', ''),
      '#format' => variable_get('opensanmateo_layout_banner_format', NULL),
    );
  }
  return $form;
}

/**
 * Implements hook_block_save().
 */
function opensanmateo_layout_block_save($delta = '', $edit = array()) {
  if ($delta == 'opensanmateo_layout_banner') {
    variable_set('opensanmateo_layout_banner_content', $edit['banner_content']['value']);
    variable_set('opensanmateo_layout_banner_format', $edit['banner_content']['format']);
  }
  return;
}

/**
 * Implements hook_block_view().
 */
function opensanmateo_layout_block_view($delta = '') {
  switch ($delta) {
    case 'opensanmateo_layout_banner':
      $block['content'] = variable_get('opensanmateo_layout_banner_content', '');
      break;
    case 'opensanmateo_layout_site_brand':
      $slogan = variable_get('site_slogan', '');
      $name = variable_get('site_name', '');
      $logo = theme_get_setting('logo');
      dpm($slogan);
      dpm($logo);
      $block['content'] = theme('opensanmateo_layout_site_brand', array('logo' => $logo, 'slogan' => $slogan, 'name' => $name));
  }
  return $block;
}

/**
 * Implements template_process_panels_add_content_modal().
 * 
 * We are removing some categories from the IPE modal window.
 */
function opensanmateo_layout_preprocess_panels_add_content_modal(&$vars) { 
  foreach ($vars['categories_array'] as $key => $category_name) {
    if (in_array(strip_tags($category_name),
      array('Activity', 'Boxes', 'Comment', 'Node (tokens)', 'Node', 'Page elements'))) {
        unset($vars['categories_array'][$key]);
      }
  }
}
